<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–æ–ª–∏–∫—ñ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --clean: #3b82f6; --bg: #f3f4f6; --warning: #d97706; --blocked: #6b7280; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #1f2937; }
        h3 { margin-top: 15px; margin-bottom: 10px; font-size: 0.9em; color: #4b5563; text-transform: uppercase; letter-spacing: 1px; }

        .table-card { border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .table-info b { font-size: 1.1em; }
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 0.85em; font-weight: 600; text-align: center; }
        
        .available { background: #dcfce7; color: #166534; }
        .reserved { background: #fee2e2; color: #991b1b; }
        .cleaning { background: #dbeafe; color: #1e40af; }
        .soon-reserved { background: #fef9c3; color: #854d0e; }
        .blocked { background: #e5e7eb; color: #374151; border: 1px dashed #9ca3af; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
        button.refresh { background: #4b5563; margin-bottom: 15px; }
        .gear-btn { background: none; color: #9ca3af; font-size: 1.2em; padding: 5px; width: auto; }
        .gear-btn:hover { color: #1f2937; }

        .action-btn { padding: 5px 10px; font-size: 0.85em; width: auto; margin-left: 5px; cursor: pointer; border-radius: 4px; border:none; color:white; }
        .btn-cancel { background: var(--danger); }
        .btn-finish { background: var(--warning); }
        .btn-clean { background: var(--clean); }
        .btn-start { background: var(--success); }
        .btn-extend { background: var(--primary); }

        details summary { cursor: pointer; font-weight: 600; padding: 10px; background: #eee; border-radius: 6px; user-select: none; }
        .log-item { font-size: 0.85em; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .log-time { color: #6b7280; margin-right: 10px; font-family: monospace; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: white; padding: 20px; border-radius: 12px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { cursor: pointer; font-size: 1.5em; line-height: 1; }
        .fading { opacity: 0.5; transition: opacity 0.2s; }
        .hidden { display: none; }
        .error-box { color: #dc2626; padding: 20px; text-align: center; border: 2px dashed #dc2626; border-radius: 8px; background: #fef2f2; }
    </style>
</head>
<body>
    <h1>üìÖ –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–æ–ª–∏–∫—ñ–≤</h1>

    <div class="grid">
        <div class="panel">
            <h2>–°—Ç–æ–ª–∏–∫–∏</h2>
            <button class="refresh" onclick="refreshAll()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
            <div id="tablesList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>

        <div class="panel">
            <h2>–ù–æ–≤–µ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</h2>
            <div class="form-group">
                <label>–ì—ñ—Å—Ç—å (–Ü–º'—è)</label>
                <input type="text" id="guestName" placeholder="–û–ª–µ–∫—Å—ñ–π">
            </div>
            <div class="row">
                <div class="form-group" style="flex:1"><label>–°—Ç–æ–ª–∏–∫</label><select id="tableSelect"></select></div>
                <div class="form-group" style="flex:1"><label>–ì–æ—Å—Ç–µ–π</label><input type="number" id="guestCount" value="2" min="1"></div>
            </div>
            <div class="row">
                <div class="form-group" style="flex:2"><label>–î–∞—Ç–∞ (–∫—Ä–æ–∫ 10 —Ö–≤)</label><input type="datetime-local" id="startTime" step="600"></div>
                <div class="form-group" style="flex:1">
                    <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</label>
                    <select id="durationSelect" onchange="toggleDurationInput()">
                        <option value="0.5">30 —Ö–≤</option>
                        <option value="1">1 –≥–æ–¥</option>
                        <option value="1.5">1.5 –≥–æ–¥</option>
                        <option value="2" selected>2 –≥–æ–¥</option>
                        <option value="3">3 –≥–æ–¥</option>
                        <option value="4">4 –≥–æ–¥</option>
                        <option value="custom">–í—Ä—É—á–Ω—É</option>
                    </select>
                    <input type="number" id="durationCustom" class="hidden" placeholder="–ì–æ–¥" step="0.1">
                </div>
            </div>
            <div class="form-group"><label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label><input type="text" id="comment"></div>
            <button onclick="createReservation()">–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>–ê–∫—Ç–∏–≤–Ω—ñ –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</h2>
        <h3>üü¢ –ó–∞—Ä–∞–∑ —É –∑–∞–ª—ñ</h3>
        <div id="seatedList"></div>
        <h3>üßπ –ù–∞ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—ñ</h3>
        <div id="cleaningList"></div>
        <h3>‚è≥ –û—á—ñ–∫—É—é—Ç—å</h3>
        <div id="upcomingList"></div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <details>
            <summary>üìú –Ü—Å—Ç–æ—Ä—ñ—è —Ç–∞ –õ–æ–≥–∏</summary>
            <div id="logsList"></div>
        </details>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header"><h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è #<span id="modalTableId"></span></h3><span class="close-modal" onclick="closeModal('settingsModal')">&times;</span></div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞</label><input type="text" id="editTableName"></div>
            <div class="row">
                <div class="form-group" style="flex:1"><label>–¢–∏–ø</label><input type="text" id="editTableType"></div>
                <div class="form-group" style="flex:1"><label>–ú—ñ—Å—Ç–∫—ñ—Å—Ç—å</label><input type="number" id="editTableCapacity"></div>
            </div>
            <button onclick="saveTableSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">
            <label>–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è</label>
            <div class="row">
                <input type="datetime-local" id="blockUntil">
                <button class="btn-cancel" onclick="blockTable()" style="width: auto;">–ë–ª–æ–∫</button>
            </div>
            <button onclick="unblockTable()" style="background:#6b7280; margin-top:5px;">–ó–Ω—è—Ç–∏ –±–ª–æ–∫</button>
            <div id="modalActiveAction" style="margin-top:10px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="extendModal">
        <div class="modal">
            <div class="modal-header"><h3>–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±—Ä–æ–Ω—å</h3><span class="close-modal" onclick="closeModal('extendModal')">&times;</span></div>
            <div class="form-group"><label>–î–æ–¥–∞—Ç–∏ —Ö–≤–∏–ª–∏–Ω:</label><input type="number" id="extendMinutes" value="30" step="10"></div>
            <button onclick="submitExtend()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3005'; 
        let currentTableId = null;
        let currentResId = null;

        setInterval(() => { if(!document.hidden) refreshAll(); }, 30000);

        function toggleDurationInput() {
            const val = document.getElementById('durationSelect').value;
            const custom = document.getElementById('durationCustom');
            if(val === 'custom') custom.classList.remove('hidden'); else custom.classList.add('hidden');
        }

        function openSettings(id, name, type, cap, activeResId, isBlocked) {
            currentTableId = id;
            document.getElementById('modalTableId').innerText = id;
            document.getElementById('editTableName').value = name;
            document.getElementById('editTableType').value = type;
            document.getElementById('editTableCapacity').value = cap;
            document.getElementById('settingsModal').style.display = 'flex';
            
            const actionDiv = document.getElementById('modalActiveAction');
            actionDiv.innerHTML = activeResId ? `<button class="btn-finish" onclick="finishReservation(${activeResId}); closeModal('settingsModal')">üõë –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ –∑–∞—Ä–∞–∑</button>` : '';
        }

        function openExtend(id) {
            currentResId = id;
            document.getElementById('extendModal').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function saveTableSettings() {
            const data = { name: document.getElementById('editTableName').value, type: document.getElementById('editTableType').value, capacity: document.getElementById('editTableCapacity').value };
            await fetch(`${API}/tables/${currentTableId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            closeModal('settingsModal'); refreshAll();
        }

        async function blockTable() {
            const date = document.getElementById('blockUntil').value;
            if (!date) return alert("–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É");
            const res = await fetch(`${API}/tables/${currentTableId}/block`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ blockedUntil: date }) });
            if (!res.ok) { const e = await res.json(); alert(e.error); } else { closeModal('settingsModal'); refreshAll(); }
        }

        async function unblockTable() {
            await fetch(`${API}/tables/${currentTableId}/block`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ blockedUntil: null }) });
            closeModal('settingsModal'); refreshAll();
        }

        async function submitExtend() {
            const min = parseInt(document.getElementById('extendMinutes').value);
            const res = await fetch(`${API}/reservations/${currentResId}/extend`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ minutes: min }) });
            if(res.ok) { alert("–£—Å–ø—ñ—à–Ω–æ"); closeModal('extendModal'); refreshAll(); } else { const e = await res.json(); alert(e.error); }
        }

        async function loadTables() {
            const list = document.getElementById('tablesList');
            list.classList.add('fading');
            await new Promise(r => setTimeout(r, 200));
            try {
                const res = await fetch(`${API}/tables`);
                if(!res.ok) throw new Error("Err");
                const json = await res.json();
                
                list.innerHTML = '';
                const select = document.getElementById('tableSelect');
                const prev = select.value;
                select.innerHTML = '';

                json.data.forEach(t => {
                    list.innerHTML += `<div class="table-card"><div class="table-info"><b>${t.name}</b> <span style="margin-left:5px; color:#555">(${t.type}) | Max ${t.capacity}</span></div><div style="display:flex; gap:10px; align-items:center"><div class="badge ${t.statusClass}">${t.statusText}</div><button class="gear-btn" onclick="openSettings(${t.id}, '${t.name}', '${t.type}', ${t.capacity}, ${t.activeReservationId}, ${t.isBlocked})">‚öôÔ∏è</button></div></div>`;
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
                if(prev) select.value = prev;
            } catch(e) { list.innerHTML = '<div class="error-box">üî¥ –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è</div>'; }
            list.classList.remove('fading');
        }

        async function loadReservations() {
            const res = await fetch(`${API}/reservations`);
            const data = await res.json();
            const seated = document.getElementById('seatedList');
            const cleaning = document.getElementById('cleaningList');
            const upcoming = document.getElementById('upcomingList');
            seated.innerHTML = ''; cleaning.innerHTML = ''; upcoming.innerHTML = '';

            const now = Date.now();
            const active = data.filter(r => (new Date(r.startTime).getTime() + r.duration * 3600000 + 600000) > now);

            if(active.length===0) { 
                const empty = '<p style="color:#aaa">–ü—É—Å—Ç–æ</p>';
                seated.innerHTML=empty; cleaning.innerHTML=empty; upcoming.innerHTML=empty; 
                return; 
            }

            active.forEach(r => {
                const start = new Date(r.startTime).getTime();
                const end = start + r.duration * 3600000;
                const cleanEnd = end + 600000;
                const dateStr = new Date(r.startTime).toLocaleString('uk-UA', {day:'numeric', month:'numeric', hour:'2-digit', minute:'2-digit'});
                
                let html = '';
                let target = upcoming;

                if (now >= start && now < end) {
                    target = seated;
                    html = `<div class="table-card" style="border-left:4px solid var(--success)"><div><b>–ë—Ä–æ–Ω—å #${r.id}</b>: ${r.guestName}<br>–°—Ç–æ–ª–∏–∫ ${r.tableId} | ${dateStr}</div><div><button class="action-btn btn-extend" onclick="openExtend(${r.id})">+ –ß–∞—Å</button><button class="action-btn btn-finish" onclick="finishReservation(${r.id})">–ó–≤—ñ–ª—å–Ω–∏—Ç–∏</button></div></div>`;
                } else if (now >= end && now < cleanEnd) {
                    target = cleaning; 
                    html = `<div class="table-card" style="border-left:4px solid var(--clean)"><div><b>–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è #${r.tableId}</b> (–ë—Ä–æ–Ω—å #${r.id})<br>–ü—ñ—Å–ª—è: ${r.guestName}</div><div><button class="action-btn btn-clean" onclick="finishReservation(${r.id})">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button></div></div>`;
                } else {
                    html = `<div class="table-card" style="border-left:4px solid var(--warning)"><div><b>–ë—Ä–æ–Ω—å #${r.id}</b>: ${r.guestName}<br>–°—Ç–æ–ª–∏–∫ ${r.tableId} | ${dateStr}</div><div><button class="action-btn btn-start" onclick="startNow(${r.id})">–ü–æ—á–∞—Ç–∏</button><button class="action-btn btn-cancel" onclick="cancelReservation(${r.id})">‚ùå</button></div></div>`;
                }
                target.innerHTML += html;
            });
            if(seated.innerHTML==='') seated.innerHTML='<p style="color:#aaa">–ü—É—Å—Ç–æ</p>';
            if(cleaning.innerHTML==='') cleaning.innerHTML='<p style="color:#aaa">–ü—É—Å—Ç–æ</p>';
            if(upcoming.innerHTML==='') upcoming.innerHTML='<p style="color:#aaa">–ü—É—Å—Ç–æ</p>';
        }

        async function createReservation() {
            const sel = document.getElementById('durationSelect');
            let dur = parseFloat(sel.value === 'custom' ? document.getElementById('durationCustom').value : sel.value);
            const data = {
                guestName: document.getElementById('guestName').value,
                tableId: document.getElementById('tableSelect').value,
                guestCount: document.getElementById('guestCount').value,
                startTime: document.getElementById('startTime').value,
                duration: dur,
                comment: document.getElementById('comment').value
            };
            if(!data.guestName || !data.startTime) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å");
            try {
                const res = await fetch(`${API}/reservations`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Idempotency-Key': Date.now().toString()}, body: JSON.stringify(data)});
                if(res.ok) { alert("–£—Å–ø—ñ—à–Ω–æ"); refreshAll(); } else { const e = await res.json(); alert(e.error); }
            } catch(e) { alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ"); }
        }

        async function startNow(id) { 
            const res = await fetch(`${API}/reservations/${id}/start`, {method:'POST'});
            if(res.ok) refreshAll(); else { const e = await res.json(); alert(e.error); }
        }
        
        async function finishReservation(id) {
            const r = prompt("–ü—Ä–∏—á–∏–Ω–∞?", "–ó–∞–≤–µ—Ä—à–µ–Ω–æ");
            if(r) { await fetch(`${API}/reservations/${id}/finish`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:r})}); refreshAll(); }
        }
        async function cancelReservation(id) {
            const r = prompt("–ü—Ä–∏—á–∏–Ω–∞?", "–í—ñ–¥–º—ñ–Ω–∞");
            if(r) { await fetch(`${API}/reservations/${id}`, {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:r})}); refreshAll(); }
        }
        async function loadLogs() {
            try {
                const res = await fetch(`${API}/logs`);
                const d = await res.json();
                document.getElementById('logsList').innerHTML = d.map(l => {
                    const t = new Date(l.timestamp).toLocaleString('uk-UA');
                    return `<div class="log-item"><span class="log-time">[${t}]</span><span><b>${l.action}</b> ${l.details}</span></div>`;
                }).join('');
            } catch(e) { document.getElementById('logsList').innerHTML = '<p>–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ</p>'; }
        }
        function refreshAll() { loadTables(); loadReservations(); loadLogs(); }
        refreshAll();
    </script>
</body>
</html>